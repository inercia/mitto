# Mitto Default Configuration
# This file contains the default settings that are used when settings.json doesn't exist.
# Your personal settings are stored in settings.json in your Mitto data directory:
#   - macOS: ~/Library/Application Support/Mitto/settings.json
#   - Linux: ~/.local/share/mitto/settings.json
#   - Windows: %APPDATA%\Mitto\settings.json

# ACP (Agent Communication Protocol) servers
# Prompts are now loaded from MITTO_DIR/prompts/builtin/ directory
# Run 'mitto prompts update-builtin' to update builtin prompts after upgrading
#
# Each server supports:
#   command: Shell command to start the ACP server
#   cwd: (optional) Working directory for the ACP server process
#        Eliminates the need for shell tricks like 'sh -c "cd /path && command"'
#        Note: cwd is only supported with direct execution (not restricted runners)
acp:
  - auggie:
      command: auggie --allow-indexing --acp
      # cwd: /path/to/working/directory  # Optional: set process working directory

  - claude-code:
      command: npx -y @zed-industries/claude-code-acp@latest

  - cursor:
      command: npx -y @blowmage/cursor-agent-acp

# Web server configuration
web:
  host: 127.0.0.1  # Local listener always binds to 127.0.0.1 for security
  port: 8080       # Local port (use 0 for random)
  external_port: -1  # External port when auth is enabled (-1 = disabled, 0 = random, >0 = specific port)
  api_prefix: /mitto  # URL prefix for API endpoints (security through obscurity). Set to "" to disable.
  theme: v2  # Options: "default", "v2" (modern theme)

  # hooks:
  #   up:
  #     command: echo "ngrok http ${PORT}"
  #     name: "ngrok"
  #   # down:
  #   #   command: echo "Shutting down server on port ${PORT}"
  #   #   name: "cleanup"

  # auth:
  #   simple:
  #     username: admin
  #     password: your-secure-password  # Use a strong password
  #   allow:
  #     ips:  # IP addresses/CIDR ranges that bypass authentication
  #       - 127.0.0.1
  #       - ::1
  #       - 192.168.0.0/24

  # security:
  #   # Trusted reverse proxies - only trust X-Forwarded-For from these IPs
  #   # Required when running behind nginx, Caddy, or cloud load balancers
  #   trusted_proxies:
  #     - 127.0.0.1
  #     - 10.0.0.0/8
  #     - 172.16.0.0/12
  #     - 192.168.0.0/16
  #
  #   # Allowed origins for WebSocket connections (CSRF protection)
  #   # If empty, only same-origin requests are allowed
  #   # Use "*" to allow all origins (not recommended for production)
  #   allowed_origins:
  #     - https://your-domain.com
  #     - https://your-tunnel.ngrok.io
  #
  #   # Rate limiting for API requests (per IP)
  #   rate_limit_rps: 10        # Requests per second (default: 10)
  #   rate_limit_burst: 20      # Maximum burst size (default: 20)
  #
  #   # WebSocket connection limits (per IP)
  #   max_ws_connections_per_ip: 10  # Default: 10
  #
  #   # Maximum WebSocket message size in bytes
  #   max_ws_message_size: 65536     # Default: 64KB

  # Scanner Defense (only applies to external listener)
  # Automatically blocks IPs that exhibit scanner-like behavior:
  # - Requesting paths that don't exist on the server
  # - Accessing known vulnerability probe paths
  # - Sending too many suspicious requests in a short time
  #
  # scanner_defense:
  #   enabled: true                    # Enable scanner defense (default: true when external access is enabled)
  #   block_duration_seconds: 3600     # How long to block offending IPs in seconds (default: 3600 = 1h)
  #   suspicious_path_threshold: 3     # Block after this many suspicious requests (default: 3)
  #   rate_window_seconds: 60          # Time window for counting suspicious requests in seconds (default: 60 = 1m)
  #   whitelist:                       # CIDR ranges that should never be blocked
  #     - "10.0.0.0/8"
  #     - "192.168.0.0/16"

# UI settings
# ui:
#   # Confirmation dialogs - set to false to skip confirmations
#   confirmations:
#     delete_session: true  # Confirm before deleting a conversation (default: true)
#     quit_with_running_sessions: true  # Confirm before quitting with running conversations (default: true, macOS only)
#
#   # macOS desktop app settings (only applies to Mitto.app)
#   mac:
#     # Global hotkeys
#     hotkeys:
#       show_hide:
#         enabled: true
#         key: "cmd+ctrl+m"  # Hotkey to toggle app visibility
#     # Notification settings
#     notifications:
#       sounds:
#         agent_completed: true  # Play a sound when the agent finishes
#       native_enabled: false  # Use native macOS notifications instead of in-app toasts
#     # Window behavior
#     show_in_all_spaces: false  # Show window in all macOS Spaces (requires restart)
#     # Login item (requires macOS 13+)
#     start_at_login: false  # Launch Mitto automatically when you log in

# Conversation processing - transformations applied to user messages
# Processors are applied in order. Each processor specifies:
#   - when: "first" (first message only), "all" (every message), "all-except-first"
#   - position: "prepend" (before message) or "append" (after message)
#   - text: the content to insert
#
# Global processors defined here apply to all workspaces.
# Workspace-specific processors can be defined in <workspace>/.mittorc
# and will be merged with global processors (or override them with override: true).
#
# conversations:
#   processing:
#     processors:
#       # Add system context to the first message
#       - when: first
#         position: prepend
#         text: |
#           You are a helpful AI coding assistant.
#           Please follow best practices and be concise.
#
#           ---
#
#       # Add a reminder to all messages
#       - when: all
#         position: append
#         text: "\n\n[Remember: Provide working code examples]"
#
#       # Add continuation context after the first message
#       # - when: all-except-first
#       #   position: prepend
#       #   text: "[Continuing from previous context]\n\n"
#
#   # Message queue configuration
#   # When enabled, messages sent while the agent is busy are queued and
#   # automatically delivered when the agent becomes idle.
#   #
#   # queue:
#   #   # Enable/disable automatic queue processing (default: true)
#   #   # When false, messages remain in queue until manually sent or deleted
#   #   enabled: true
#   #
#   #   # Delay in seconds before sending the next queued message (default: 0)
#   #   # Useful to give users time to review agent responses before next message
#   #   delay_seconds: 0
#   #
#   #   # Maximum number of messages allowed in the queue (default: 10)
#   #   # When the queue is full, new messages are rejected with an error
#   #   max_size: 10
#   #
#   #   # Automatically generate short titles for queued messages (default: true)
#   #   # Uses the auxiliary conversation to create 2-3 word titles
#   #   auto_generate_titles: true

# Follow-up suggestions configuration
# When enabled, agent messages are analyzed asynchronously to identify
# questions or follow-up prompts, and suggested response buttons are
# displayed to the user.
#
# External images configuration
# When enabled, the Content Security Policy allows loading images from
# external HTTPS sources in rendered markdown content. Disabled by default
# for privacy (external images can track when you view messages).
conversations:
  action_buttons:
    enabled: true  # Enable follow-up suggestions by default
  # external_images:
  #   enabled: false  # Allow external HTTPS images (default: false)

# Restricted Runner Configuration (Advanced)
# By default, agents run with no restrictions (exec runner).
# You can configure per-runner-type restrictions that apply when a workspace
# uses that specific runner type.
# See docs/config/restricted.md for detailed documentation.
#
# WARNING: Restricted execution can break MCP server access.
# Only enable if you understand the implications.
#
# Global per-runner-type configuration with reasonable defaults:
restricted_runners:
  # exec: Direct execution with no restrictions (default, recommended for most users)
  # Uncomment to add restrictions even to exec runner (not recommended)
  # exec:
  #   restrictions:
  #     allow_networking: true
  #     allow_read_folders:
  #       - "$WORKSPACE"
  #     allow_write_folders:
  #       - "$WORKSPACE"

  # sandbox-exec: macOS sandbox with reasonable defaults for MCP server compatibility
  sandbox-exec:
    restrictions:
      # Allow network access (required for network-based MCP servers)
      allow_networking: true

      # Folders the agent can read from
      # These paths ensure MCP servers can be found and executed
      allow_read_folders:
        - "$WORKSPACE"              # Current workspace
        - "$HOME/.config"           # MCP server configs
        - "$HOME/.local/bin"        # Local executables
        - "$HOME/.local/share"      # Local data files
        - "$HOME/.npm"              # npm global packages (npx-based MCP)
        - "$HOME/.cargo/bin"        # Rust-based MCP servers
        - "$HOME/.cache"            # Cache directory (MCP servers may need this)
        - "/usr/local/bin"          # System-wide executables
        - "/opt/homebrew/bin"       # Homebrew (macOS Apple Silicon)
        - "/opt/homebrew/lib"       # Homebrew libraries
        - "$TMPDIR"                 # Temporary files

      # Folders the agent can write to
      allow_write_folders:
        - "$WORKSPACE"              # Current workspace
        - "$HOME/.cache"            # Cache directory
        - "$TMPDIR"                 # Temporary files

      # Folders to explicitly deny access to (security)
      deny_folders:
        - "$HOME/.ssh"              # SSH keys
        - "$HOME/.aws"              # AWS credentials
        - "$HOME/.gnupg"            # GPG keys

    # Merge strategy: extend (merge with agent/workspace configs)
    merge_strategy: "extend"

  # firejail: Linux namespace isolation with reasonable defaults
  firejail:
    restrictions:
      # Allow network access (required for network-based MCP servers)
      allow_networking: true

      # Folders the agent can read from
      allow_read_folders:
        - "$WORKSPACE"              # Current workspace
        - "$HOME/.config"           # MCP server configs
        - "$HOME/.local/bin"        # Local executables
        - "$HOME/.local/share"      # Local data files
        - "$HOME/.npm"              # npm global packages
        - "$HOME/.cargo/bin"        # Rust-based MCP servers
        - "$HOME/.cache"            # Cache directory
        - "/usr/local/bin"          # System-wide executables
        - "/usr/bin"                # System binaries
        - "/bin"                    # Essential binaries
        - "$TMPDIR"                 # Temporary files
        - "/tmp"                    # Temporary files (fallback)

      # Folders the agent can write to
      allow_write_folders:
        - "$WORKSPACE"              # Current workspace
        - "$HOME/.cache"            # Cache directory
        - "$TMPDIR"                 # Temporary files
        - "/tmp"                    # Temporary files (fallback)

      # Folders to explicitly deny access to (security)
      deny_folders:
        - "$HOME/.ssh"              # SSH keys
        - "$HOME/.aws"              # AWS credentials
        - "$HOME/.gnupg"            # GPG keys

    # Merge strategy: extend (merge with agent/workspace configs)
    merge_strategy: "extend"

  # docker: Container execution (requires Docker to be installed and running)
  # Note: For Docker, the agent must be installed in the container image
  docker:
    restrictions:
      # Allow network access (required for network-based MCP servers)
      allow_networking: true

      # Docker-specific configuration
      docker:
        # Default image (users should override this with their own image)
        # The image must contain the ACP agent executable
        image: "ubuntu:22.04"

        # Resource limits (optional but recommended)
        memory_limit: "2g"          # 2GB RAM limit
        cpu_limit: "2.0"            # 2 CPU cores

        # Additional volumes to mount (optional)
        # The workspace is automatically mounted at the same path
        # volumes:
        #   - "$HOME/.config:/root/.config:ro"  # Mount config as read-only

      # Note: For Docker, allow_read_folders and allow_write_folders are less relevant
      # because the container has its own filesystem. The workspace is auto-mounted.
      # However, you can still use them to restrict access within the container.
      allow_read_folders:
        - "$WORKSPACE"

      allow_write_folders:
        - "$WORKSPACE"

    # Merge strategy: replace (don't merge with agent/workspace configs for Docker)
    # This is because Docker configuration is typically very specific
    merge_strategy: "replace"

# Per-agent restricted runner configuration example:
# You can override the global defaults for specific agents
# acp_servers:
#   - name: auggie
#     command: auggie --allow-indexing --acp
#     # No restricted_runners = uses global defaults
#
#   - name: experimental
#     command: experimental-agent --acp
#     restricted_runners:
#       sandbox-exec:
#         # Override global sandbox-exec config for this agent
#         restrictions:
#           allow_networking: false  # WARNING: Breaks network-based MCP servers
#           allow_read_folders:
#             - "$WORKSPACE"
#         merge_strategy: "replace"  # Don't merge with global config
#
#   - name: docker-agent
#     command: my-agent --acp
#     restricted_runners:
#       docker:
#         restrictions:
#           docker:
#             image: "my-custom-agent:latest"  # Must contain agent + MCP servers
#             memory_limit: "4g"
#         merge_strategy: "replace"
