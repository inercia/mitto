---
description: macOS native app with WKWebView, keyboard shortcuts, trackpad gestures, icon generation, native folder picker, and WebView debugging
globs:
  - "cmd/mitto-app/**/*"
  - "platform/mac/**/*"
  - "web/static/utils/native.js"
  - "**/*.m"
  - "**/*.h"
keywords:
  - WKWebView
  - macOS app
  - native app
  - keyboard shortcut
  - trackpad gesture
  - localStorage sync
  - webview.log
  - webview log
  - mitto.log
  - access.log
  - log file
  - log files
  - debug logs
  - debugging
  - console log
  - UI crash
  - UI freeze
  - app crash
  - rendering issue
  - Library/Logs/Mitto
---

# macOS App Development

## Icon Generation

The macOS app icon is generated by `platform/mac/generate-icon.sh`:
- Requires Python 3 with Pillow (`pip3 install Pillow`)
- Generates all required sizes (16x16 to 1024x1024) as PNG files
- Converts to `.icns` using `iconutil`
- Icon design: Speech balloon with three dots (chat bubble)

**Icon cache issues**: macOS aggressively caches app icons. After updating:
```bash
# Copy new icon to app bundle
cp platform/mac/AppIcon.icns Mitto.app/Contents/Resources/AppIcon.icns

# Touch app to invalidate cache
touch Mitto.app

# Restart Finder and Dock
killall Finder
killall Dock
```

If icon still doesn't update, rebuild the app: `make clean-mac-app && make build-mac-app`

## Environment Detection

### Detecting Native App vs Browser

The frontend detects the macOS app by checking for bound native functions:

```javascript
// Primary detection method
const isMacApp = typeof window.mittoPickFolder === 'function';

// Alternative checks
const hasNativeFolderPicker = typeof window.mittoPickFolder === 'function';
const hasNativeURLOpener = typeof window.mittoOpenExternalURL === 'function';
```

### Bound Native Functions

| Function | Purpose | Availability |
|----------|---------|--------------|
| `window.mittoPickFolder()` | Native folder picker dialog | macOS app only |
| `window.mittoOpenExternalURL(url)` | Open URL in default browser | macOS app only |
| `window.mittoNewConversation()` | Create new conversation | Exposed by web frontend |
| `window.mittoFocusInput()` | Focus the chat input | Exposed by web frontend |
| `window.mittoToggleSidebar()` | Toggle sidebar visibility | Exposed by web frontend |
| `window.mittoCloseConversation()` | Close current conversation | Exposed by web frontend |
| `window.mittoNextConversation()` | Navigate to next conversation | Exposed by web frontend |
| `window.mittoPrevConversation()` | Navigate to previous conversation | Exposed by web frontend |

### Conditional UI Based on Environment

```javascript
// Show native folder picker button only in macOS app
{isMacApp && html`
    <button onClick=${handleBrowseFolder}>Browse...</button>
`}

// Use different URL opening behavior
function openExternalURL(url) {
    if (typeof window.mittoOpenExternalURL === 'function') {
        window.mittoOpenExternalURL(url);  // Native
    } else {
        window.open(url, '_blank', 'noopener,noreferrer');  // Browser
    }
}
```

## Keyboard Shortcuts System

### Architecture

Keyboard shortcuts are handled at two levels:

1. **Native macOS menu** (`cmd/mitto-app/menu_darwin.m`): Shortcuts handled by the native app menu
2. **Web frontend JavaScript** (`web/static/app.js`): Shortcuts handled by `keydown` event listeners

### Shortcut Categories

| Category | Handler | Works in Browser | Works in macOS App |
|----------|---------|------------------|-------------------|
| Native menu shortcuts | `menu_darwin.m` | ❌ No | ✅ Yes |
| Web shortcuts | `handleGlobalKeyDown` | ✅ Yes | ✅ Yes |
| Global hotkey | Carbon Events API | ❌ No | ✅ Yes (system-wide) |
| Trackpad gestures | `menu_darwin.m` (scroll event monitor) | ❌ No | ✅ Yes |

## Trackpad Gestures

### Two-Finger Horizontal Swipe Navigation

The macOS app supports two-finger horizontal swipe gestures to navigate between conversations:

| Gesture | Action | Implementation |
|---------|--------|----------------|
| Swipe left (two fingers) | Go to next conversation | Calls `window.mittoNextConversation()` |
| Swipe right (two fingers) | Go to previous conversation | Calls `window.mittoPrevConversation()` |

**Implementation details** (`cmd/mitto-app/menu_darwin.m`):
- Uses `NSEvent addLocalMonitorForEventsMatchingMask:NSEventMaskScrollWheel` to track scroll events
- Accumulates scroll delta during the gesture (from `NSEventPhaseBegan` to `NSEventPhaseEnded`)
- Requires horizontal movement > 100px and dominant over vertical (2:1 ratio)
- Passes events through so normal WebView scrolling still works
- Calls Go callback `goSwipeNavigationCallback()` which evaluates JavaScript

### KEYBOARD_SHORTCUTS Array

Define shortcuts centrally for the help dialog:

```javascript
const KEYBOARD_SHORTCUTS = [
    // macOnly: true = only works in native macOS app
    { keys: '⌘⇧M', description: 'Show/hide window', macOnly: true, section: 'Global' },
    { keys: '⌘N', description: 'New conversation', macOnly: true, section: 'Conversations' },
    // No macOnly = works in both browser and macOS app
    { keys: '⌘1-9', description: 'Switch to conversation 1-9', section: 'Conversations' },
    { keys: '⌘,', description: 'Settings', section: 'Navigation' },
];
```

### Filtering Shortcuts by Environment

```javascript
// Check if running in the native macOS app
const isMacApp = typeof window.mittoPickFolder === 'function';

// Filter shortcuts - hide macOnly when in browser
KEYBOARD_SHORTCUTS.forEach(shortcut => {
    if (shortcut.macOnly && !isMacApp) {
        return;  // Skip native-only shortcuts in browser
    }
    // Add to sections...
});
```

### Adding New Web Shortcuts

To add a shortcut that works in both browser and macOS app:

1. Add to `KEYBOARD_SHORTCUTS` array (no `macOnly` flag)
2. Add handler in `handleGlobalKeyDown` useEffect:

```javascript
useEffect(() => {
    const handleGlobalKeyDown = (e) => {
        if ((e.metaKey || e.ctrlKey) && !e.shiftKey && !e.altKey) {
            if (e.key === ',') {
                e.preventDefault();
                if (!configReadonly) {
                    setSettingsDialog({ isOpen: true, forceOpen: false });
                }
            }
        }
    };
    window.addEventListener('keydown', handleGlobalKeyDown);
    return () => window.removeEventListener('keydown', handleGlobalKeyDown);
}, [configReadonly]);
```

### Adding Native macOS Shortcuts

To add a shortcut that only works in the macOS app:

1. Add to `KEYBOARD_SHORTCUTS` with `macOnly: true`
2. Add menu item in `menu_darwin.m`:

```objc
NSMenuItem *item = [[NSMenuItem alloc] initWithTitle:@"Action Name"
                                              action:@selector(actionMethod:)
                                       keyEquivalent:@"k"];
[item setKeyEquivalentModifierMask:NSEventModifierFlagCommand];
[item setTarget:handler];
[menu addItem:item];
```

3. Add handler method in `MittoMenuHandler`
4. Add Go callback in `main.go`
5. Expose JavaScript function via `window.mittoActionName`

## WKWebView Debugging

### localStorage Synchronization Issues

**Symptom**: macOS app shows stale/missing messages while browser shows correct state.

**Root Cause**: WKWebView's localStorage can become desynchronized from the process data store. This manifests as:
- `lastSeenSeq` values being stale or missing
- Messages appearing in browser but not in native app
- Reconnect syncs not loading new events

**Debugging Steps**:

1. **Check localStorage values in WKWebView**:
   ```javascript
   // In Safari Web Inspector (Develop → Mac → Mitto window)
   Object.keys(localStorage).filter(k => k.includes('mitto'))
   localStorage.getItem('mitto_last_seen_seq_SESSION_ID')
   ```

2. **Compare with browser**:
   - Open same URL in Safari browser
   - Compare localStorage values
   - If different, WKWebView has stale state

3. **Force localStorage clear**:
   ```javascript
   // Clear all Mitto keys
   Object.keys(localStorage)
     .filter(k => k.startsWith('mitto_'))
     .forEach(k => localStorage.removeItem(k));
   location.reload();
   ```

### WKWebView vs Browser Differences

| Aspect | Browser | WKWebView |
|--------|---------|-----------|
| localStorage persistence | Standard | Process-bound, can desync |
| Cache behavior | Standard | More aggressive caching |
| Network handling | Standard | May differ for WebSocket |
| Dev tools | Built-in | Safari → Develop menu |

### Enabling Safari Web Inspector for WKWebView

In `main.go`, development builds enable Web Inspector:

```go
// Enable Web Inspector for debugging (development only)
webView.SetDeveloperExtrasEnabled(true)
```

Then: Safari → Develop → Your Mac → Mitto window

### Common WKWebView Issues

| Issue | Symptom | Solution |
|-------|---------|----------|
| Stale localStorage | Missing messages | Clear localStorage, reload |
| Cached JavaScript | Old behavior after code change | Clear WKWebView cache |
| WebSocket zombie | "Connected" but no messages | Keepalive mechanism detects |
| Different behavior | Works in browser, not in app | Check Web Inspector console |

## WebView Console Log File

The macOS app captures JavaScript console output to a log file for debugging UI issues.

### Log File Location

```
~/Library/Logs/Mitto/webview.log
```

Rotated backups: `webview.log.1`, `webview.log.2`, `webview.log.3` (max 10MB per file, 3 backups)

### When to Check the Log File

**Always inspect `webview.log` when:**

1. **Users report macOS app UI problems**:
   - App crashes or freezes
   - Rendering issues (blank screen, missing elements)
   - UI not responding to clicks/input

2. **WebView-related issues**:
   - Page not loading or showing errors
   - JavaScript errors in the frontend
   - WebSocket connection problems
   - localStorage sync issues

3. **Native integration problems**:
   - Keyboard shortcuts not working
   - Trackpad gestures not responding
   - Native folder picker failures
   - Menu actions not triggering

### Log Format

Each log entry follows this format:
```
[2024-01-15T10:30:45.123-08:00] [LEVEL] message content
```

Log levels: `LOG`, `WARN`, `ERROR`, `DEBUG`, `INFO`

### What to Look For

| Pattern | Indicates |
|---------|-----------|
| `[ERROR]` entries | JavaScript errors, failed operations |
| `WebSocket` errors | Connection issues, reconnection failures |
| `localStorage` errors | State persistence problems |
| `mittoPickFolder` / `mittoOpenExternalURL` | Native bridge failures |
| `undefined` or `null` errors | Missing data or uninitialized state |
| `CORS` or `fetch` errors | Network/API issues |
| Stack traces | JavaScript exceptions with source location |

### Debugging Workflow

1. **Reproduce the issue** in the macOS app

2. **Read recent log entries**:
   ```bash
   # View last 100 lines
   tail -100 ~/Library/Logs/Mitto/webview.log

   # Follow log in real-time while reproducing
   tail -f ~/Library/Logs/Mitto/webview.log

   # Search for errors
   grep -i error ~/Library/Logs/Mitto/webview.log | tail -50

   # Search for specific session
   grep "SESSION_ID" ~/Library/Logs/Mitto/webview.log
   ```

3. **Check for patterns**:
   ```bash
   # Count errors by type
   grep '\[ERROR\]' ~/Library/Logs/Mitto/webview.log | sort | uniq -c | sort -rn

   # Find WebSocket issues
   grep -i websocket ~/Library/Logs/Mitto/webview.log | tail -20

   # Check for native bridge calls
   grep -E 'mitto(PickFolder|OpenExternalURL|LogConsole)' ~/Library/Logs/Mitto/webview.log
   ```

4. **Cross-reference with Safari Web Inspector**:
   - Open Safari → Develop → Your Mac → Mitto window
   - Compare console output with log file
   - Check Network tab for failed requests

5. **Check rotated logs** if issue occurred earlier:
   ```bash
   # Search all log files
   grep -i error ~/Library/Logs/Mitto/webview.log*
   ```

### Common Error Patterns

| Error Pattern | Likely Cause | Solution |
|---------------|--------------|----------|
| `TypeError: Cannot read property 'X' of undefined` | Missing data, race condition | Check data loading order |
| `WebSocket connection failed` | Server not running, network issue | Verify server is running |
| `localStorage.getItem returned null` | First run or cleared storage | Handle null case in code |
| `mittoPickFolder is not a function` | Code running in browser, not app | Check `isMacApp` detection |
| `Failed to fetch` | API endpoint unreachable | Check server logs |
| `Maximum call stack exceeded` | Infinite loop/recursion | Check useEffect dependencies |

### Adding Console Logging for Debugging

When debugging issues, add strategic console logs:

```javascript
// These will appear in ~/Library/Logs/Mitto/webview.log
console.log('[Component] State:', { sessionId, messages: messages.length });
console.warn('[Component] Unexpected condition:', condition);
console.error('[Component] Failed to load:', error);
```

Use prefixes like `[ComponentName]` to make log entries searchable.

## Debugging with Log Files

The macOS app writes to multiple log files for comprehensive debugging. **Always check these logs when investigating issues.**

### Log File Locations

All logs are stored in `~/Library/Logs/Mitto/`:

| Log File | Purpose | Rotation |
|----------|---------|----------|
| `mitto.log` | Go application logs (server, ACP, sessions) | 10MB, 3 backups |
| `access.log` | Security events (auth, unauthorized access) | 10MB, 1 backup |
| `webview.log` | JavaScript console output from WKWebView | 10MB, 3 backups |

### Quick Commands for Debugging

```bash
# View all log files
ls -la ~/Library/Logs/Mitto/

# Tail all logs simultaneously (in separate terminals or use multitail)
tail -f ~/Library/Logs/Mitto/mitto.log
tail -f ~/Library/Logs/Mitto/access.log
tail -f ~/Library/Logs/Mitto/webview.log

# Search across all logs
grep -r "error" ~/Library/Logs/Mitto/

# View recent entries from all logs
tail -50 ~/Library/Logs/Mitto/*.log
```

### Which Log to Check

| Issue Type | Primary Log | Secondary Log |
|------------|-------------|---------------|
| **App startup failures** | `mitto.log` | - |
| **Server/API errors** | `mitto.log` | `access.log` |
| **Authentication issues** | `access.log` | `mitto.log` |
| **Unauthorized access attempts** | `access.log` | - |
| **UI rendering problems** | `webview.log` | - |
| **JavaScript errors** | `webview.log` | - |
| **WebSocket connection issues** | `mitto.log` | `webview.log` |
| **Session loading/saving** | `mitto.log` | - |
| **ACP communication** | `mitto.log` | - |
| **Rate limiting triggers** | `access.log` | `mitto.log` |

### mitto.log - Go Application Logs

Contains all Go-level logging from the server, ACP client, session management, etc.

```bash
# View recent application logs
tail -100 ~/Library/Logs/Mitto/mitto.log

# Search for errors
grep -i "level=ERROR" ~/Library/Logs/Mitto/mitto.log

# Search for specific session
grep "session_id=SESSION_ID" ~/Library/Logs/Mitto/mitto.log

# Search for ACP-related logs
grep "component=acp" ~/Library/Logs/Mitto/mitto.log

# Search for WebSocket events
grep -i "websocket\|ws\|client" ~/Library/Logs/Mitto/mitto.log
```

**Key patterns to look for:**

| Pattern | Indicates |
|---------|-----------|
| `level=ERROR` | Application errors |
| `level=WARN` | Warnings that may indicate issues |
| `component=web` | Web server events |
| `component=auth` | Authentication events |
| `component=session` | Session management |
| `session_id=` | Session-specific events |
| `client_id=` | WebSocket client events |

### access.log - Security Events

Contains security-focused events for auditing and debugging auth issues.

```bash
# View recent security events
tail -50 ~/Library/Logs/Mitto/access.log

# Find failed login attempts
grep "login_failed\|unauthorized" ~/Library/Logs/Mitto/access.log

# Find rate limiting events
grep "rate_limit" ~/Library/Logs/Mitto/access.log

# Find external access attempts
grep "external" ~/Library/Logs/Mitto/access.log
```

**Event types logged:**

| Event | Description |
|-------|-------------|
| `login_success` | Successful authentication |
| `login_failed` | Failed login attempt |
| `unauthorized` | Access without valid session |
| `session_validated` | Session cookie validated |
| `rate_limited` | Request blocked by rate limiter |
| `external_connection` | Connection from non-localhost |

### Comprehensive Debugging Workflow

1. **Reproduce the issue** while tailing logs:
   ```bash
   # In one terminal
   tail -f ~/Library/Logs/Mitto/mitto.log ~/Library/Logs/Mitto/webview.log
   ```

2. **Identify the timeframe** of the issue

3. **Search for errors around that time**:
   ```bash
   # Search all logs for errors in the last hour
   find ~/Library/Logs/Mitto -name "*.log" -exec grep -l "ERROR\|error" {} \;
   ```

4. **Correlate across logs**:
   - Find session ID in `mitto.log`
   - Search for same session in `webview.log`
   - Check `access.log` for auth-related events

5. **Check rotated logs** if issue occurred earlier:
   ```bash
   # Search all log files including rotated ones
   grep -r "pattern" ~/Library/Logs/Mitto/
   ```

### Log Levels

The macOS app defaults to `INFO` level. To enable debug logging:

```bash
# Set environment variable before launching
export MITTO_LOG_LEVEL=debug
open /Applications/Mitto.app

# Or launch from terminal
MITTO_LOG_LEVEL=debug /Applications/Mitto.app/Contents/MacOS/mitto-app
```

### CLI vs macOS App Logging

| Feature | `mitto web` CLI | macOS App |
|---------|-----------------|-----------|
| Console output | ✅ Always | ✅ Always (for Console.app) |
| `mitto.log` file | ❌ Disabled by default | ✅ Enabled |
| `access.log` file | ❌ Disabled by default | ✅ Enabled |
| `webview.log` file | N/A | ✅ Enabled |

To enable file logging for CLI:
```bash
# Via settings.json
{
  "web": {
    "access_log": {
      "enabled": true
    }
  }
}

# Or via command line flag
mitto web --access-log ~/Library/Logs/Mitto/access.log
```
