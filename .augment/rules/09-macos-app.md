---
description: macOS native app with WKWebView, icon generation, native folder picker, and environment detection
globs:
  - "cmd/mitto-app/**/*"
  - "platform/mac/**/*"
  - "web/static/utils/native.js"
  - "**/*.m"
  - "**/*.h"
keywords:
  - WKWebView
  - macOS app
  - native app
  - native folder picker
  - mittoPickFolder
  - mittoOpenExternalURL
---

# macOS App Development

## Icon Generation

The macOS app icon is generated by `platform/mac/generate-icon.sh`:
- Requires Python 3 with Pillow (`pip3 install Pillow`)
- Generates all required sizes (16x16 to 1024x1024) as PNG files
- Converts to `.icns` using `iconutil`
- Icon design: Speech balloon with three dots (chat bubble)

**Icon cache issues**: macOS aggressively caches app icons. After updating:
```bash
# Copy new icon to app bundle
cp platform/mac/AppIcon.icns Mitto.app/Contents/Resources/AppIcon.icns

# Touch app to invalidate cache
touch Mitto.app

# Restart Finder and Dock
killall Finder
killall Dock
```

If icon still doesn't update, rebuild the app: `make clean-mac-app && make build-mac-app`

## Environment Detection

### Detecting Native App vs Browser

The frontend detects the macOS app by checking for bound native functions:

```javascript
// Primary detection method
const isMacApp = typeof window.mittoPickFolder === 'function';

// Alternative checks
const hasNativeFolderPicker = typeof window.mittoPickFolder === 'function';
const hasNativeURLOpener = typeof window.mittoOpenExternalURL === 'function';
```

### Bound Native Functions

| Function | Purpose | Availability |
|----------|---------|--------------|
| `window.mittoPickFolder()` | Native folder picker dialog | macOS app only |
| `window.mittoPickImages()` | Native image picker dialog | macOS app only |
| `window.mittoPickFiles()` | Native file picker dialog (any file type) | macOS app only |
| `window.mittoOpenExternalURL(url)` | Open URL in default browser | macOS app only |
| `window.mittoOpenFileURL(url)` | Open file URL in default app | macOS app only |
| `window.mittoNewConversation()` | Create new conversation | Exposed by web frontend |
| `window.mittoFocusInput()` | Focus the chat input | Exposed by web frontend |
| `window.mittoToggleSidebar()` | Toggle sidebar visibility | Exposed by web frontend |
| `window.mittoCloseConversation()` | Close current conversation | Exposed by web frontend |
| `window.mittoNextConversation()` | Navigate to next conversation | Exposed by web frontend |
| `window.mittoPrevConversation()` | Navigate to previous conversation | Exposed by web frontend |

### Conditional UI Based on Environment

```javascript
// Show native folder picker button only in macOS app
{isMacApp && html`
    <button onClick=${handleBrowseFolder}>Browse...</button>
`}

// Use different URL opening behavior
function openExternalURL(url) {
    if (typeof window.mittoOpenExternalURL === 'function') {
        window.mittoOpenExternalURL(url);  // Native
    } else {
        window.open(url, '_blank', 'noopener,noreferrer');  // Browser
    }
}
```

## WKWebView Patterns

### localStorage Synchronization Issues

**Symptom**: macOS app shows stale/missing messages while browser shows correct state.

**Root Cause**: WKWebView's localStorage can become desynchronized from the process data store. This manifests as:
- `lastSeenSeq` values being stale or missing
- Messages appearing in browser but not in native app
- Reconnect syncs not loading new events

**Solution**: Calculate sync state dynamically from application state, not localStorage. See `34-anti-patterns.md` for the pattern.

### WKWebView vs Browser Differences

| Aspect | Browser | WKWebView |
|--------|---------|-----------|
| localStorage persistence | Standard | Process-bound, can desync |
| Cache behavior | Standard | More aggressive caching |
| Network handling | Standard | May differ for WebSocket |
| Dev tools | Built-in | Safari → Develop menu |

### Enabling Safari Web Inspector for WKWebView

In `main.go`, development builds enable Web Inspector:

```go
// Enable Web Inspector for debugging (development only)
webView.SetDeveloperExtrasEnabled(true)
```

Then: Safari → Develop → Your Mac → Mitto window

### Common WKWebView Issues

| Issue | Symptom | Solution |
|-------|---------|----------|
| Stale localStorage | Missing messages | Clear localStorage, reload |
| Cached JavaScript | Old behavior after code change | Clear WKWebView cache |
| WebSocket zombie | "Connected" but no messages | Keepalive mechanism detects |
| Different behavior | Works in browser, not in app | Check Web Inspector console |

**For detailed debugging with log files, see `41-debugging-logs.md`.**
