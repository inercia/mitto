---
description: macOS native app with WKWebView, keyboard shortcuts, trackpad gestures, icon generation, and native folder picker
globs:
  - "cmd/mitto-app/**/*"
  - "platform/mac/**/*"
  - "web/static/utils/native.js"
  - "**/*.m"
  - "**/*.h"
---

# macOS App Development

## Icon Generation

The macOS app icon is generated by `platform/mac/generate-icon.sh`:
- Requires Python 3 with Pillow (`pip3 install Pillow`)
- Generates all required sizes (16x16 to 1024x1024) as PNG files
- Converts to `.icns` using `iconutil`
- Icon design: Speech balloon with three dots (chat bubble)

**Icon cache issues**: macOS aggressively caches app icons. After updating:
```bash
# Copy new icon to app bundle
cp platform/mac/AppIcon.icns Mitto.app/Contents/Resources/AppIcon.icns

# Touch app to invalidate cache
touch Mitto.app

# Restart Finder and Dock
killall Finder
killall Dock
```

If icon still doesn't update, rebuild the app: `make clean-mac-app && make build-mac-app`

## Environment Detection

### Detecting Native App vs Browser

The frontend detects the macOS app by checking for bound native functions:

```javascript
// Primary detection method
const isMacApp = typeof window.mittoPickFolder === 'function';

// Alternative checks
const hasNativeFolderPicker = typeof window.mittoPickFolder === 'function';
const hasNativeURLOpener = typeof window.mittoOpenExternalURL === 'function';
```

### Bound Native Functions

| Function | Purpose | Availability |
|----------|---------|--------------|
| `window.mittoPickFolder()` | Native folder picker dialog | macOS app only |
| `window.mittoOpenExternalURL(url)` | Open URL in default browser | macOS app only |
| `window.mittoNewConversation()` | Create new conversation | Exposed by web frontend |
| `window.mittoFocusInput()` | Focus the chat input | Exposed by web frontend |
| `window.mittoToggleSidebar()` | Toggle sidebar visibility | Exposed by web frontend |
| `window.mittoCloseConversation()` | Close current conversation | Exposed by web frontend |
| `window.mittoNextConversation()` | Navigate to next conversation | Exposed by web frontend |
| `window.mittoPrevConversation()` | Navigate to previous conversation | Exposed by web frontend |

### Conditional UI Based on Environment

```javascript
// Show native folder picker button only in macOS app
{isMacApp && html`
    <button onClick=${handleBrowseFolder}>Browse...</button>
`}

// Use different URL opening behavior
function openExternalURL(url) {
    if (typeof window.mittoOpenExternalURL === 'function') {
        window.mittoOpenExternalURL(url);  // Native
    } else {
        window.open(url, '_blank', 'noopener,noreferrer');  // Browser
    }
}
```

## Keyboard Shortcuts System

### Architecture

Keyboard shortcuts are handled at two levels:

1. **Native macOS menu** (`cmd/mitto-app/menu_darwin.m`): Shortcuts handled by the native app menu
2. **Web frontend JavaScript** (`web/static/app.js`): Shortcuts handled by `keydown` event listeners

### Shortcut Categories

| Category | Handler | Works in Browser | Works in macOS App |
|----------|---------|------------------|-------------------|
| Native menu shortcuts | `menu_darwin.m` | ❌ No | ✅ Yes |
| Web shortcuts | `handleGlobalKeyDown` | ✅ Yes | ✅ Yes |
| Global hotkey | Carbon Events API | ❌ No | ✅ Yes (system-wide) |
| Trackpad gestures | `menu_darwin.m` (scroll event monitor) | ❌ No | ✅ Yes |

## Trackpad Gestures

### Two-Finger Horizontal Swipe Navigation

The macOS app supports two-finger horizontal swipe gestures to navigate between conversations:

| Gesture | Action | Implementation |
|---------|--------|----------------|
| Swipe left (two fingers) | Go to next conversation | Calls `window.mittoNextConversation()` |
| Swipe right (two fingers) | Go to previous conversation | Calls `window.mittoPrevConversation()` |

**Implementation details** (`cmd/mitto-app/menu_darwin.m`):
- Uses `NSEvent addLocalMonitorForEventsMatchingMask:NSEventMaskScrollWheel` to track scroll events
- Accumulates scroll delta during the gesture (from `NSEventPhaseBegan` to `NSEventPhaseEnded`)
- Requires horizontal movement > 100px and dominant over vertical (2:1 ratio)
- Passes events through so normal WebView scrolling still works
- Calls Go callback `goSwipeNavigationCallback()` which evaluates JavaScript

### KEYBOARD_SHORTCUTS Array

Define shortcuts centrally for the help dialog:

```javascript
const KEYBOARD_SHORTCUTS = [
    // macOnly: true = only works in native macOS app
    { keys: '⌘⇧M', description: 'Show/hide window', macOnly: true, section: 'Global' },
    { keys: '⌘N', description: 'New conversation', macOnly: true, section: 'Conversations' },
    // No macOnly = works in both browser and macOS app
    { keys: '⌘1-9', description: 'Switch to conversation 1-9', section: 'Conversations' },
    { keys: '⌘,', description: 'Settings', section: 'Navigation' },
];
```

### Filtering Shortcuts by Environment

```javascript
// Check if running in the native macOS app
const isMacApp = typeof window.mittoPickFolder === 'function';

// Filter shortcuts - hide macOnly when in browser
KEYBOARD_SHORTCUTS.forEach(shortcut => {
    if (shortcut.macOnly && !isMacApp) {
        return;  // Skip native-only shortcuts in browser
    }
    // Add to sections...
});
```

### Adding New Web Shortcuts

To add a shortcut that works in both browser and macOS app:

1. Add to `KEYBOARD_SHORTCUTS` array (no `macOnly` flag)
2. Add handler in `handleGlobalKeyDown` useEffect:

```javascript
useEffect(() => {
    const handleGlobalKeyDown = (e) => {
        if ((e.metaKey || e.ctrlKey) && !e.shiftKey && !e.altKey) {
            if (e.key === ',') {
                e.preventDefault();
                if (!configReadonly) {
                    setSettingsDialog({ isOpen: true, forceOpen: false });
                }
            }
        }
    };
    window.addEventListener('keydown', handleGlobalKeyDown);
    return () => window.removeEventListener('keydown', handleGlobalKeyDown);
}, [configReadonly]);
```

### Adding Native macOS Shortcuts

To add a shortcut that only works in the macOS app:

1. Add to `KEYBOARD_SHORTCUTS` with `macOnly: true`
2. Add menu item in `menu_darwin.m`:

```objc
NSMenuItem *item = [[NSMenuItem alloc] initWithTitle:@"Action Name"
                                              action:@selector(actionMethod:)
                                       keyEquivalent:@"k"];
[item setKeyEquivalentModifierMask:NSEventModifierFlagCommand];
[item setTarget:handler];
[menu addItem:item];
```

3. Add handler method in `MittoMenuHandler`
4. Add Go callback in `main.go`
5. Expose JavaScript function via `window.mittoActionName`

